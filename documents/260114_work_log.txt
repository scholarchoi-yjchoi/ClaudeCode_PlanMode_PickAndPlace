================================================================================
Isaac Sim 4.5 Pick and Place 프로젝트 작업 로그
================================================================================
작성일: 2026-01-14
프로젝트 경로: /home/yjchoi/ClaudeCode_PlanMode_PickAndPlace

================================================================================
1. 프로젝트 목표
================================================================================
- Franka Panda 로봇이 YCB 바나나 객체를 테이블에서 집어서 컨테이너에 놓는
  Pick and Place 데모 구현
- Isaac Sim 4.5 새로운 API 사용 (isaacsim.core.api.*)
- 로봇 동작의 실제 성공/실패를 검증하는 시스템 구현

================================================================================
2. 주요 문제점 및 해결 과정
================================================================================

[문제 1] 로봇이 완전히 잘못된 위치로 이동
-------------------------------------------------------------------------
- 증상: End Effector XY 거리가 0.5417m - 바나나와 전혀 다른 위치로 이동
- 원인: 객체 위치가 Franka 로봇의 작업 범위 밖에 있었음
- 해결:
  * TABLE_POSITION을 [0.35, 0.0, 0.25]로 조정
  * PLACEMENT_BOUNDS를 x:[0.25~0.45], y:[0.10~0.30]으로 조정
  * 공식 예제의 위치값 참고 (~[0.3, 0.3, 0.3])

[문제 2] XY는 맞지만 Z 높이가 너무 높음
-------------------------------------------------------------------------
- 증상: EE z=0.36 vs 바나나 z=0.27 - 로봇이 충분히 내려가지 않음
- 원인: 테이블 높이가 너무 낮아 로봇이 해당 XY에서 낮은 Z에 도달 불가
- 해결: 테이블 높이를 z=0.25로 조정, 객체 z=0.27로 설정

[문제 3] 바나나가 움직이지 않음 (그립 실패)
-------------------------------------------------------------------------
- 증상: 로봇 동작은 완료되지만 바나나가 전혀 이동하지 않음
- 원인: prim_utils.create_prim()으로 생성한 YCB 객체에 Physics 속성 없음
- 해결: UsdPhysics API 추가
  ```python
  from pxr import UsdPhysics, PhysxSchema

  # YCB 객체에 물리 속성 추가
  UsdPhysics.RigidBodyAPI.Apply(prim)
  UsdPhysics.CollisionAPI.Apply(prim)
  mass_api = UsdPhysics.MassAPI.Apply(prim)
  mass_api.CreateMassAttr(0.1)  # 100g
  ```

[문제 4] 바나나가 움직이지만 잘못된 위치로 이동
-------------------------------------------------------------------------
- 증상: Distance moved: 0.2728m - 바나나는 움직이지만 목표가 아닌 곳으로
- 원인: Physics가 활성화되면 바나나가 settle 후 다른 위치에 있는데,
        로봇은 여전히 초기 저장된 위치를 타겟팅
- 해결: world.reset() 후 바나나의 실제 위치를 다시 가져오도록 수정
  ```python
  # Physics settle 후 바나나의 실제 위치 획득
  banana_position = verifier.get_banana_position().copy()
  verifier.pick_target = banana_position
  ```

================================================================================
3. 구현한 주요 기능
================================================================================

[VerificationTracker 클래스]
-------------------------------------------------------------------------
로봇 동작의 실제 성공/실패를 추적하고 검증하는 클래스

주요 메서드:
- initialize(): 바나나 초기 위치 저장
- get_ee_position(): End Effector 현재 위치 반환
- get_banana_position(): 바나나 현재 위치 반환
- log_phase_status(): Phase별 상세 로깅 (EE/바나나/타겟 위치)
- verify_final_result(): 최종 결과 검증 (바나나가 컨테이너로 이동했는지)

[Phase별 검증 로직]
-------------------------------------------------------------------------
Phase 0: Moving above pick
Phase 1: Lowering to grasp - EE XY 거리 체크 (< 0.05m 여야 정상)
Phase 2: Waiting settle
Phase 3: Closing gripper
Phase 4: Lifting object
Phase 5: Moving to place XY
Phase 6: Lowering to place - Place XY 거리 체크
Phase 7: Opening gripper
Phase 8: Lifting up
Phase 9: Going home

================================================================================
4. 현재 코드 구조 (franka_ycb_pick_place.py)
================================================================================

주요 Import:
- isaacsim.core.api.* (Isaac Sim 4.5 새 API)
- isaacsim.robot.manipulators.examples.franka.*
- isaacsim.core.prims.SingleXFormPrim (위치 추적용)
- pxr.UsdPhysics (물리 속성용)

주요 설정값:
- TABLE_POSITION = [0.35, 0.0, 0.25]
- CONTAINER_POSITION = [0.35, -0.25, 0.26]
- PLACE_POSITION = [0.35, -0.25, 0.30]
- PLACEMENT_BOUNDS: x[0.25~0.45], y[0.10~0.30], z=0.27

Controller:
- PickPlaceController + RMPFlowController
- end_effector_offset = [0, 0.005, 0] (공식 예제와 동일)

================================================================================
5. 테스트 결과 요약
================================================================================

테스트 1: EE XY distance = 0.5417m (실패 - 완전히 다른 위치)
테스트 2: EE XY distance = 0.0105m (개선 - XY 정확, Z 높음)
테스트 3: 바나나 이동 안 함 (Physics 없음)
테스트 4: 바나나 0.2728m 이동 (Physics 추가됨, 하지만 잘못된 방향)
테스트 5: (최신 수정 적용 - 실제 위치 사용) - 테스트 필요

================================================================================
6. 다음 단계 (TODO)
================================================================================

[ ] 최신 수정사항 테스트 (physics settle 후 실제 위치 사용)
[ ] 그립 성공 시 바나나가 컨테이너로 정확히 이동하는지 확인
[ ] 필요시 gripper 타이밍/높이 조정
[ ] 필요시 end_effector_offset 미세 조정
[ ] 성공적인 pick and place 완료 확인

================================================================================
7. 실행 방법
================================================================================

cd ~/isaac_sim_4.5
./python.sh ~/ClaudeCode_PlanMode_PickAndPlace/franka_ycb_pick_place.py

================================================================================
8. 참고 파일
================================================================================

- 메인 스크립트: franka_ycb_pick_place.py
- 계획 문서: ~/.claude/plans/curried-splashing-waffle.md
- Isaac Sim 경로: ~/isaac_sim_4.5/

================================================================================
